<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrar Vehiculos</title>
    <link rel="stylesheet" href="../styles.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div class="container">
        <div>
            <h1>Administrar Vehiculos</h1>
            <button class="btn-detalles" onclick="window.location.href='./newVehiculo.html'">Nuevo Vehiculo </button>
            <button class="btn-detalles" onclick="window.location.href='../../views/admin.html'">Volver atras </button>
        </div>
        <div>
            <table>
                <thead>
                    <tr>
                        <th>Id Vehiculo</th>
                        <th>Marca</th>
                        <th>Modelo</th>
                        <th>Año</th>
                        <th>Editar</th>
                        <th>Más Acciones</th>
                    </tr>
                </thead>
                <tbody id="vehiculos-body">
                    <!-- Cargaremos dinámicamente el contenido JSON (BackEnd) -->
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
    function cargarVehiculos(){
        fetch("http://localhost:4050/vehiculos")
        .then(function(respuestaTextoPlano){
            //La respuesta (OK o KO) la transformo en JSON
            return respuestaTextoPlano.json()
        })
        .then(function(data){
            //Gestionamos el OK con "data" que tendrá formato JSON
            const tbody = document.getElementById("vehiculos-body")
            for(let vehiculo of data){
                //Para cada usuario, creamos una fila
                const row = document.createElement("tr")

                const idCell = document.createElement("td")
                idCell.innerText = vehiculo.id_vehiculo

                const marcaCell = document.createElement("td")
                marcaCell.innerText = vehiculo.marca

                const modeloCell = document.createElement("td")
                modeloCell.innerText = vehiculo.modelo

                const anyoCell = document.createElement("td")
                anyoCell.innerText = vehiculo.anyo

            
                //SHOW PASSWORD
                const detallesCell = document.createElement("td")
                const detallesButton = document.createElement("button")
                detallesButton.innerText = "Ver Detalles"
                detallesButton.classList.add("btn-detalles")
                detallesButton.onclick = function(){
                    Swal.fire({
                        title: "Detalles",
                        text: "¡Mostrando Detalles!",
                        icon: "success"
                    })
                    .then(function(result){
                        if(result.isConfirmed){
                            window.location.href = "showVehiculo.html?id_vehiculo=" + vehiculo.id_vehiculo
                        }
                    })
                }
                detallesCell.appendChild(detallesButton)

                //EDIT BUTTON
                const editCell = document.createElement("td")
                const editButton = document.createElement("button")
                editButton.innerText = "Editar Datos"
                editButton.classList.add("btn-editar")

                editButton.onclick = function(){
                window.location.href = "editVehiculo.html?id_vehiculo=" + vehiculo.id_vehiculo
                }
                editCell.appendChild(editButton)

                //DELETE BUTTON
                const deleteButton = document.createElement("button")
                deleteButton.innerText = "Eliminar"
                deleteButton.classList.add("btn-delete")

                deleteButton.onclick = function(){
                    eliminarVehiculo(vehiculo.id_vehiculo)
                }
                editCell.appendChild(deleteButton)

                row.appendChild(idCell)
                row.appendChild(marcaCell)
                row.appendChild(modeloCell)
                row.appendChild(anyoCell)
                row.appendChild(detallesCell)
                row.appendChild(editCell)

                tbody.appendChild(row)
            }
        })
    }

    function eliminarVehiculo(id_vehiculo){
        Swal.fire({
            title:"¿Estás seguro?",
            text:`Eliminar Vehiculo '${id_vehiculo}'. Esta acción no se puede deshacer`,
            icon:"warning",
            showCancelButton:true,
            confirmButtonText:"Sí, eliminar",
            cancelButtonText:"Cancelar"
        })
        .then(function(result){
            if(result.isConfirmed){
                fetch("http://localhost:4050/vehiculos/" + id_vehiculo,{
                    method:"DELETE"
                })
                .then(function(respuestaTextoPlano){
                    return respuestaTextoPlano.json()
                })
                .then(function(data){
                    //OK
                    console.log(data)
                    Swal.fire({
                        title: "Eliminado!",
                        text: "¡Vehiculo eliminado con éxito!",
                        icon: "success"
                    })
                    .then(function(){
                            //Refresco de página en JS desde el servidor y no desde caché
                            window.location.reload(true)
                            //cargarVehiculos()
                        })
                })
                .catch(function(error){
                    console.log(error)
                    Swal.fire({
                        title: "¡Error!",
                        text: error,
                        icon: "error"
                    });
                })
            }
        })
    }
    cargarVehiculos()
    </script>
</body>
</html>